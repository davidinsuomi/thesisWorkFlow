<!-- HelloWorld BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Fri Jun 13 09:25:03 EEST 2014 -->
<process name="ExecuteWorkflow"
    targetNamespace="http://spica"
    xmlns:tns="http://spica"
    xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
    xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
    xsi:noNamespaceSchemaLocation="datatype.xsd"
    >

    <!-- ================================================================= -->
    <!-- PARTNERLINKS                                                      -->
    <!-- List of services participating in this BPEL process               -->
    <!-- ================================================================= -->
    <partnerLinks>
        <partnerLink name="BLEScanning"
            partnerLinkType="tns:GetData">coap://localhost/coapIP</partnerLink>
        <partnerLink name="getWellKnowInCoap"
            partnerLinkType="tns:GetData">$scanCoapResultUsingBLE</partnerLink>
        <partnerLink name="matchingCoap"
            partnerLinkType="tns:GetData">coap://localhost:5684/temperatureMatching</partnerLink>

    </partnerLinks>

    <!-- ================================================================= -->
    <!-- VARIABLES                                                         -->
    <!-- List of messages and XML documents used within this BPEL process  -->
    <!-- ================================================================= -->
    <variables>
        <!--
         Reference to the message that will be returned to the requester
         -->
        <variable name="scanCoapResultUsingBLE"
            messageType="tns:List"/>
        <variable name="coapServiceResponse"
            messageType="tns:String"/>
        <variable name="postData"
            messageType="tns:String"/>
        <variable name="mathcingResult"
            messageType="tns:String"/>
    </variables>

    <!-- ================================================================= -->
    <!-- ORCHESTRATION LOGIC                                               -->
    <!-- Set of activities coordinating the flow of messages across the    -->
    <!-- services integrated within this business process                  -->
    <!-- ================================================================= -->
    <sequence name="main">

        <invoke name="findCoap"
            partnerLink="BLEScanning"
            inputVariable=""
            outputVariable="scanCoapResultUsingBLE"/>
        <forEach countername='n'>
            <startCounterValue>0</startCounterValue>
            <finalCounterValue>2</finalCounterValue>
            <sequence>
                <invoke name="CoapServiceDiscovery"
                    partnerLink="getWellKnowInCoap"
                    operation=".well-known/core"
                    outputVariable="coapServiceResponse"/>
                <assign name="assign">
                    <copy>
                        <from variable="coapServiceResponse" />
                        <to variable="postData" />
                    </copy>
                </assign>
                <invoke name="invokeMatchingCoap"
                    partnerLink="matchingCoap"
                    operation="POST"
                    inputVariable="postData"
                    outputVariable="mathcingResult"/>
            </sequence>
        </forEach>
        <invoke name="endPoint" partnerLink="" operation="" inputVariable="" outputVariable="" />
    </sequence>
</process>

